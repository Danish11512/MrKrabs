---
name: Financial APIs Integration
overview: Set up a complete financial APIs system with mock data generation using Faker.js. This includes database schema for financial providers, accounts, and transactions; API routes for connecting to fake financial institutions; a dashboard portal for managing connections; and ERD diagrams documenting the data model.
todos:
  - id: schema-extensions
    content: Extend database schema with financial_providers, provider_connections, financial_accounts, and financial_transactions tables
    status: pending
  - id: type-definitions
    content: Create type definitions for financial providers, accounts, transactions, and connections in types/ directory
    status: pending
  - id: faker-generators
    content: Build Faker.js generators for providers, accounts, and transactions with realistic data
    status: pending
    dependencies:
      - type-definitions
  - id: seed-providers
    content: Create seed script to populate initial financial providers (Amex, Chase, etc.)
    status: pending
    dependencies:
      - schema-extensions
  - id: api-providers
    content: Implement /api/financial/providers route to list available providers
    status: pending
    dependencies:
      - schema-extensions
      - type-definitions
  - id: api-connections
    content: Implement connection management API routes (create, list, authorize, disconnect)
    status: pending
    dependencies:
      - schema-extensions
      - type-definitions
      - faker-generators
  - id: api-accounts
    content: Implement accounts API routes (list, get details, get transactions)
    status: pending
    dependencies:
      - schema-extensions
      - type-definitions
  - id: api-transactions
    content: Implement transactions API route with filtering and pagination
    status: pending
    dependencies:
      - schema-extensions
      - type-definitions
  - id: dashboard-components
    content: "Build dashboard UI components: FinancialConnections, AccountsList, TransactionsList"
    status: pending
    dependencies:
      - type-definitions
  - id: oauth-flow
    content: Create fake OAuth authorization page and flow
    status: pending
    dependencies:
      - api-connections
  - id: dashboard-integration
    content: Integrate financial components into DashboardClient with proper layout
    status: pending
    dependencies:
      - dashboard-components
      - oauth-flow
  - id: erd-documentation
    content: Update ERD diagrams with API flow and connection lifecycle documentation
    status: pending
---

# Financial APIs Integration Plan

## Overview

This plan implements a complete financial data integration system using mock data generated by Faker.js. Users can connect to multiple fake financial institutions (starting with American Express) through a dashboard portal, authenticate, and receive transactional data, account history, and balances.

## Architecture Components

### 1. Database Schema Extensions

**Location**: `lib/db/schema.ts`

Add new tables following the ERD in `ERD_DIAGRAMS_FOR_PLAN.md`:

- **financial_providers**: Stores available financial institutions (Amex, Chase, etc.)
- **provider_connections**: Tracks user connections to providers with auth tokens
- **financial_accounts**: Stores accounts from connected providers
- **financial_transactions**: Stores transaction history from accounts
- **balance_snapshots**: Stores historical balance data (optional, for balance history tracking)

**Key Design Decisions**:

- Use UUIDs for all primary keys
- Use `decimal` type for financial amounts (not float) - critical for financial precision
- Store encrypted access tokens for connections (use existing session encryption pattern)
- Track connection status (authorizing, connected, disconnected, error, expired)
- Support multiple account types (credit_card, checking, savings, investment)
- Store balances as provided by provider (not calculated from transactions) - real APIs provide balances directly
- Support account subtypes (e.g., credit_card: rewards, business, platinum; checking: personal, business)
- Include transaction type (debit/credit) - essential for credit cards vs checking accounts
- Add historical balance snapshots table for balance history tracking

### 2. Type Definitions

**New Files**:

- `types/financial-provider.type.ts` - Provider interfaces
- `types/financial-account.type.ts` - Account interfaces  
- `types/financial-transaction.type.ts` - Transaction interfaces
- `types/provider-connection.type.ts` - Connection interfaces

**Updates**:

- `types/index.ts` - Re-export all new types

**Type Structure**:

- `FinancialProvider` - Provider metadata
- `ProviderConnection` - User-provider connection with status
- `FinancialAccount` - Account details (balance, type, subtype, limits)
- `FinancialTransaction` - Transaction data (amount, type: debit/credit, date, category, merchant)
- `BalanceSnapshot` - Historical balance data (date, balance value)

### 3. Mock Data Generation with Faker

**New File**: `lib/financial/faker-generators.ts`

Create Faker-based generators for:

- **Financial Providers**: Generate provider data (Amex, Chase, Bank of America, etc.)
- **Accounts**: Generate realistic account data (account numbers, balances, credit limits)
- **Accounts**: Generate realistic account data with:
  - Account numbers (masked format: ****1234)
  - Account subtypes (rewards cards, business accounts, etc.)
  - Balances (provided directly, not calculated)
  - Credit limits for credit cards
  - Statement dates and due dates for credit cards

- **Transactions**: Generate transaction history with:
  - Realistic merchant names
  - Transaction type (debit/credit) - critical for proper display
  - Category assignments (Shopping, Food, Travel, etc.)
  - Date ranges (past 3-6 months default)
  - Amount distributions (realistic spending patterns)
  - Location data (city, state, country)
  - Status (posted, pending, refunded)

**Faker Configuration**:

- Use `@faker-js/faker` package (add to dependencies)
- Seed for consistent data during development
- Generate 3-6 months of transaction history per account
- Generate balances directly (as real APIs do) - balances are authoritative from provider
- Ensure transaction amounts align with account type (credit cards: negative for purchases, positive for payments)

### 4. API Routes

**New Routes**:

#### `/app/api/financial/providers/route.ts`

- `GET`: List all available financial providers
- Returns provider metadata (name, slug, logo, supported account types)

#### `/app/api/financial/connections/route.ts`

- `GET`: List user's connections with status
- `POST`: Create new connection (initiates fake OAuth flow)
  - Body: `{ providerId: string }`
  - Returns: `{ connectionId, status: 'authorizing', authorizeUrl }`

#### `/app/api/financial/connections/[connectionId]/route.ts`

- `GET`: Get connection details and status
- `POST`: Sync connection (triggers data refresh)
  - Supports incremental sync (only fetch new transactions since last sync)
  - Returns: `{ syncedAt, accountsUpdated, transactionsAdded }`
- `DELETE`: Disconnect a provider connection
  - Validates connection belongs to user
  - Optionally cascade delete accounts/transactions (or mark as disconnected)

#### `/app/api/financial/connections/[connectionId]/authorize/route.ts`

- `POST`: Complete fake OAuth authorization
- Generates fake access token
- Creates accounts and transactions using Faker
- Returns connection status

#### `/app/api/financial/accounts/route.ts`

- `GET`: List all user's accounts across all connections
- Query params: `connectionId`, `type`, `providerId`

#### `/app/api/financial/accounts/[accountId]/route.ts`

- `GET`: Get account details with current balance
  - Returns full account object including balance, limits, statement info

#### `/app/api/financial/accounts/[accountId]/transactions/route.ts`

- `GET`: Get transactions for account
  - Query params: `startDate`, `endDate`, `category`, `status`, `type` (debit/credit)
  - Pagination: cursor-based (recommended) or offset-based
  - Returns: `{ transactions: [], pagination: { cursor, hasMore } }`

#### `/app/api/financial/transactions/route.ts`

- `GET`: List all user's transactions across all accounts
- Query params: `accountId`, `connectionId`, `startDate`, `endDate`, `category`, `status`, `type` (debit/credit)
- Pagination: cursor-based (recommended) with `cursor` and `limit` params
- Returns: `{ transactions: [], pagination: { cursor, hasMore, total } }`
- Supports sorting: `sortBy` (date, amount) and `sortOrder` (asc, desc)

**Authentication**: All routes use `getCurrentUser()` from `@/lib/auth/session`

### 5. Dashboard Portal UI

**New Component**: `components/dashboard/FinancialConnections.tsx`

Features:

- **Provider Grid**: Display available providers as cards
- **Connection Status**: Show connected/disconnected status per provider
- **Connect Button**: Initiate fake OAuth flow
- **Account Summary**: Show connected accounts with balances
- **Quick Stats**: Total balance, recent transactions count

**New Component**: `components/dashboard/AccountsList.tsx`

Features:

- List all connected accounts
- Show account type, balance, provider
- Link to transaction history
- Account status indicators

**New Component**: `components/dashboard/TransactionsList.tsx`

Features:

- Display transactions in table/card format
- Filter by account, date range, category
- Show merchant, amount, date, category
- Pagination support

**Update**: `components/dashboard/DashboardClient.tsx`

Add new sections:

- Financial Connections portal
- Accounts overview
- Recent transactions

### 6. Fake OAuth Flow

**Flow**:

1. User clicks "Connect" on provider card
2. Frontend calls `POST /api/financial/connections` with `providerId`
3. Backend creates connection with status "authorizing"
4. Frontend redirects to fake OAuth page (or shows modal)
5. User "authenticates" (just a button click in fake flow)
6. Frontend calls `POST /api/financial/connections/[connectionId]/authorize`
7. Backend:

   - Generates fake access token (simulates OAuth token)
   - Uses Faker to create 1-3 accounts per connection
   - For each account, generates 3-6 months of transaction history
   - Stores balances directly (as real APIs provide them)
   - Updates connection status to "connected"
   - Sets `lastSyncedAt` timestamp

8. Frontend refreshes to show new accounts and data

**New Page**: `app/financial/authorize/[connectionId]/page.tsx`

- Simple page with "Authorize" button
- Shows provider name and what data will be accessed
- On click, calls authorize API and redirects to dashboard

### 7. Data Seeding

**New File**: `scripts/seed-financial-providers.ts`

Script to seed initial financial providers:

- American Express
- Chase Bank
- Bank of America
- Wells Fargo
- Capital One

Each provider includes:

- Name, slug, logo URL (optional)
- Supported account types array

### 8. Background Jobs Integration

**Update**: `lib/jobs/processors/financial-calculations.ts`

Add job types:

- `sync-provider-connection`: Sync data from provider (future: real API calls)
- `calculate-account-balance`: Recalculate balance from transactions
- `categorize-transactions`: Auto-categorize transactions (future ML feature)

**Note**: For now, balances calculated on-the-fly from transactions. Background jobs can be added later for performance.

### 9. ERD Documentation

**New File**: `ERD_DIAGRAMS_FOR_PLAN.md`

Create comprehensive ERD documentation including:

- Complete entity relationships with all fields
- Cardinality and constraints (foreign keys, unique constraints)
- Index strategy for performance
- Data flow diagrams
- API endpoint flow diagram
- Mock data generation flow
- Connection lifecycle state machine
- Balance snapshot relationships (if implemented)

**Key Entities**:

- `users` (existing)
- `financial_providers` - Available institutions
- `provider_connections` - User-provider links with auth tokens
- `financial_accounts` - Accounts from providers (with balances, limits)
- `financial_transactions` - Transaction history (with type: debit/credit)
- `balance_snapshots` - Historical balances (optional)

## Implementation Order

1. **Database Schema** - Add tables to `schema.ts`, generate migration
2. **Type Definitions** - Create all type files in `types/`
3. **Faker Generators** - Build data generation utilities
4. **Seed Script** - Create initial provider data
5. **API Routes** - Implement all API endpoints
6. **Dashboard Components** - Build UI components
7. **Integration** - Wire everything together in dashboard
8. **Testing** - Verify end-to-end flow

## Dependencies to Add

```json
{
  "@faker-js/faker": "^8.x.x"
}
```

## Key Files to Create/Modify

**New Files**:

- `lib/db/schema.ts` (extend with financial tables)
- `types/financial-provider.type.ts`
- `types/financial-account.type.ts`
- `types/financial-transaction.type.ts`
- `types/provider-connection.type.ts`
- `lib/financial/faker-generators.ts`
- `app/api/financial/providers/route.ts`
- `app/api/financial/connections/route.ts`
- `app/api/financial/connections/[connectionId]/route.ts`
- `app/api/financial/connections/[connectionId]/authorize/route.ts`
- `app/api/financial/accounts/route.ts`
- `app/api/financial/accounts/[accountId]/route.ts`
- `app/api/financial/accounts/[accountId]/transactions/route.ts`
- `app/api/financial/transactions/route.ts`
- `ERD_DIAGRAMS_FOR_PLAN.md` (new file)
- `components/dashboard/FinancialConnections.tsx`
- `components/dashboard/AccountsList.tsx`
- `components/dashboard/TransactionsList.tsx`
- `app/financial/authorize/[connectionId]/page.tsx`
- `scripts/seed-financial-providers.ts`

**Modified Files**:

- `types/index.ts` - Add re-exports
- `components/dashboard/DashboardClient.tsx` - Add financial sections
- `package.json` - Add @faker-js/faker dependency

## Security Considerations

- Access tokens stored encrypted (use existing session encryption pattern from `lib/auth/session-config.ts`)
- All API routes require authentication via `getCurrentUser()`
- User can only access their own connections/accounts/transactions
- Validate all user inputs (connectionId, accountId belong to user) - use database queries with WHERE clauses
- Rate limiting on data generation (prevent abuse) - limit connection creation frequency
- Input validation using Zod schemas (follow existing pattern from `lib/auth/validation.ts`)
- Error messages don't leak sensitive information (generic errors for unauthorized access)

## Error Handling

- **Connection Errors**: Handle expired tokens, network failures, provider downtime
- **Sync Errors**: Retry logic with exponential backoff, store error state in connection
- **Validation Errors**: Return 400 with specific field errors (Zod validation)
- **Authorization Errors**: Return 403 (not 401) when resource doesn't belong to user
- **Not Found**: Return 404 for missing resources
- **Rate Limiting**: Return 429 with retry-after header

## Real-World Alignment Notes

This plan aligns with real financial API patterns:

- **OAuth Flow**: Real providers (Plaid, Yodlee, MX) use OAuth 2.0 - our mock simulates this
- **Data Structure**: Matches industry-standard structure (User → Connection → Account → Transaction)
- **Balance Storage**: Real APIs provide balances directly (not calculated) - we store them the same way
- **Transaction Types**: Real APIs distinguish debit/credit - we include this field
- **Pagination**: Real APIs use cursor-based pagination for large datasets
- **Incremental Sync**: Real providers support fetching only new transactions since last sync
- **Error Handling**: Real APIs have similar error patterns (expired tokens, rate limits, etc.)

## Future Enhancements (Out of Scope)

- Real OAuth integration with actual financial APIs (Plaid, Yodlee, MX)
- Transaction categorization ML model
- Recurring transaction detection
- Budget tracking and alerts
- Export functionality (CSV, PDF)
- Real-time webhooks for transaction updates
- Historical balance snapshots with charting
- Multi-currency support